# Telegram notification bot

Telegram-бот, предназначенный для создания напоминаний. Позволяет пользователям устанавливать напоминания о событиях и управлять ими.

## Функциональные возможности
- **Создание напоминаний:** пользователь отправляет описание события и время, через которое нужно напомнить.
- **Удаление напоминаний:** пользователь может удалить ненужное напоминание.
- **Просмотр активных напоминаний:** пользователь может получить список всех текущих активных напоминаний.

## Технологии
- **Go:** Язык программирования, используемый для разработки бота.
- **Telegram API:** Используется библиотека tgbotapi для взаимодействия с Telegram.
- **RabbitMQ:** Используется для управления временем отправки напоминаний с помощью алгоритма отложенных уведомлений.
- **PostgreSQL:** База данных для хранения информации о напоминаниях.

## Как работает бот
- **Создание напоминания:** Пользователь отправляет команду с описанием события и временным интервалом, через который нужно напомнить.
- **Сохранение** Бот сохраняет напоминание в базе данных.
- **Отслеживание времени:** Сообщение добавляется в RabbitMQ и ожидает истечения заданного времени, которое рассчитывается и управляется с помощью алгоритма отложенных уведомлений.
- **Отправка напоминания:** Выполненное сообщение попадает к боту, и он отправляет напоминания пользователю.

## Как работает алгоритм отложенных уведомлений
Для точного управления временем отправки напоминаний используется RabbitMQ. Основные этапы работы алгоритма:

1) **Конфигурация очередей:**
   - Создаются несколько временных очередей с различными значениями TTL (time-to-live). Количество очередей и значения TTL настраиваются в .env файле.
   - Каждая очередь имеет своё время жизни и выходную очередь (данная очередь для всех единая), в которую сообщения перемещаются по истечении TTL.

2) **Планирование сообщений:**
   - Сообщения добавляются в одну из временных очередей в зависимости от рассчитанного времени задержки.
   - Эти очереди не имеют консьюмеров. Сообщения остаются в очереди до истечения TTL, после чего они перемещаются в выходную очередь.

3) **Обработка сообщений:**
   - Консьюмер подписан на выходную очередь. При получении сообщения консьюмер проверяет оставшееся время до выполнения напоминания.
   - Если время до выполнения меньше, чем TTL самой маленькой очереди, сообщение считается выполненным, и бот отправляет напоминание пользователю.
   - Если время до выполнения больше, сообщение помещается во временную очередь с соответствующим TTL.

4) **Настройка и масштабирование:**
   - Конфигурация TTL и количество очередей могут быть изменены через .env файл, что позволяет легко масштабировать и адаптировать систему под различные нагрузки.

## Переменные окружения

Пример .env файла:

```
BOT_TOKEN=token
RABBITMQ_DEFAULT_USER=guest
RABBITMQ_DEFAULT_PASS=guest
RABBITMQ_UI_PORT=15672
RABBITMQ_HOST=rabbitmq
RABBITMQ_PORT=5672
QUEUE_TTLS=30,60,300,600,1800,3600,7200,10800  # in seconds
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=postgres
DB_PORT=5432
DB_NAME=tasks
```

## Требования

- Docker

## Начало работы

Склонируйте репозиторий, создайте .env файл и из папки tg-notification-bot запустите:

```docker network create bot_network && docker-compose up -d```